
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.5">
    
    
      
        <title>JRF&JMC&JCMD - Simmon NoteBook</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#jrfjmcjcmd" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Simmon NoteBook" class="md-header__button md-logo" aria-label="Simmon NoteBook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Simmon NoteBook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              JRF&JMC&JCMD
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Simmon NoteBook" class="md-nav__button md-logo" aria-label="Simmon NoteBook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Simmon NoteBook
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Learning-Note
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Elasticsearch
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Elasticsearch" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Elasticsearch
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          Queries
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Queries" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Queries
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Elasticsearch/queries/Boolean%20Query/" class="md-nav__link">
        Boolean Query
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Elasticsearch/queries/Compound%20queries/" class="md-nav__link">
        Compound queries
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Elasticsearch/queries/Full%20text%20queries/" class="md-nav__link">
        Full text queries
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Elasticsearch/queries/Match%20boolean%20prefix%20query/" class="md-nav__link">
        Match boolean prefix query
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Elasticsearch/queries/Match%20query/" class="md-nav__link">
        Match query
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Elasticsearch/queries/Query%20DSL/" class="md-nav__link">
        Query DSL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Elasticsearch/queries/Resocing/" class="md-nav__link">
        Resocing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Elasticsearch/queries/%E8%A1%B0%E5%87%8F%E5%87%BD%E6%95%B0/" class="md-nav__link">
        衰减函数
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          JVM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="JVM" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          JVM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          JRF&JMC&JCMD
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        JRF&JMC&JCMD
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#jfr" class="md-nav__link">
    JFR
  </a>
  
    <nav class="md-nav" aria-label="JFR">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jfr_1" class="md-nav__link">
    什么是JFR
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jfr_2" class="md-nav__link">
    为什么使用JFR
  </a>
  
    <nav class="md-nav" aria-label="为什么使用JFR">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    有哪些关键特性
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jfr-event" class="md-nav__link">
    JFR的核心-事件Event
  </a>
  
    <nav class="md-nav" aria-label="JFR的核心-事件Event">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event" class="md-nav__link">
    Event按照采集方式分为三种：
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jfr_3" class="md-nav__link">
    如何开启JFR
  </a>
  
    <nav class="md-nav" aria-label="如何开启JFR">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jvm" class="md-nav__link">
    JVM参数启动
  </a>
  
    <nav class="md-nav" aria-label="JVM参数启动">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#-xxstartflightrecording" class="md-nav__link">
    -XX:StartFlightRecording参数说明
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-xxflightrecorderoption" class="md-nav__link">
    -XX:FlightRecorderOption参数说明
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jcmd" class="md-nav__link">
    JCMD启动
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Lucene
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Lucene" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Lucene
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Lucene/Lucene%20Segment%20Merge%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="md-nav__link">
        Lucene Segment Merge原理及源码分析
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Lucene/Lucene%20index%20file%28translation%29/" class="md-nav__link">
        Lucene index file(translation)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Lucene/Similarity/" class="md-nav__link">
        Similarity
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#jfr" class="md-nav__link">
    JFR
  </a>
  
    <nav class="md-nav" aria-label="JFR">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jfr_1" class="md-nav__link">
    什么是JFR
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jfr_2" class="md-nav__link">
    为什么使用JFR
  </a>
  
    <nav class="md-nav" aria-label="为什么使用JFR">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    有哪些关键特性
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jfr-event" class="md-nav__link">
    JFR的核心-事件Event
  </a>
  
    <nav class="md-nav" aria-label="JFR的核心-事件Event">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event" class="md-nav__link">
    Event按照采集方式分为三种：
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jfr_3" class="md-nav__link">
    如何开启JFR
  </a>
  
    <nav class="md-nav" aria-label="如何开启JFR">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jvm" class="md-nav__link">
    JVM参数启动
  </a>
  
    <nav class="md-nav" aria-label="JVM参数启动">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#-xxstartflightrecording" class="md-nav__link">
    -XX:StartFlightRecording参数说明
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-xxflightrecorderoption" class="md-nav__link">
    -XX:FlightRecorderOption参数说明
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jcmd" class="md-nav__link">
    JCMD启动
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="jrfjmcjcmd">JRF&amp;JMC&amp;JCMD</h1>
<h2 id="jfr">JFR</h2>
<h3 id="jfr_1">什么是JFR</h3>
<blockquote>
<p>JFR 是 <a href="https://so.csdn.net/so/search?q=Java&amp;spm=1001.2101.3001.7020">Java</a> Flight Record （Java飞行记录） 的缩写，是 JVM 内置的基于事件的JDK监控记录框架。这个起名就是参考了黑匣子对于飞机的作用，将Java进程比喻成飞机飞行。顾名思义，这是一个收集运行的JAVA应用的<strong>诊断信息</strong>和<strong>分析数据</strong>。<strong>JDK11</strong>开始集成进JVM，几乎不会造成性能开销，因此即使在生产环境中也可以使用。</p>
<p>如果是利用默认配置启动这个记录，性能非常高效，对于业务影响很小，因为这个框架本来就是用来长期在线上部署的框架。这个记录可以输出成二进制文件，用户可以指定最大记录时间，或者最大记录大小，供用户在需要的时候输出成文件进行事后分析。</p>
</blockquote>
<h3 id="jfr_2">为什么使用JFR</h3>
<blockquote>
<p>有些问题开发测试阶段很难发现，需要在生产环境才会出现。JFR使用在生产环境，可以更好的定位问题。官方说，目标是开启 JFR 监控（默认配置），对性能的影响在1%之内，对JVM Runtime 和 GC，OS 以及 Java 库进行全方位的监控。</p>
</blockquote>
<p><strong>注意</strong>：生产环境配置不建议长期使用profile，否则会增加很大的性能开销。settings的详细配置在<strong>$JAVA_HOME/lib/jfr/</strong>，default.jfr和profile.jfr。</p>
<h4 id="_1">有哪些关键特性</h4>
<ul>
<li>低开销（在配置正确的情况下），可在生产环境核心业务进程中始终在线运行。当然，也可以随时开启与关闭。</li>
<li>可以查看出问题时间段内进行分析，可以分析 Java 应用程序，JVM 内部以及当前Java进程运行环境等多因素。</li>
<li>JFR基于事件采集，可以分析非常底层的信息，例如对象分配，方法采样与热点方法定位与调用堆栈，安全点分析与锁占用时长与堆栈分析，GC 相关分析以及 JIT 编译器相关分析（例如 CodeCache ） </li>
<li>完善的 API 定义，用户可以自定义事件生产与消费。</li>
</ul>
<h3 id="jfr-event">JFR的核心-事件Event</h3>
<p>在JFR中，任何JVM的行为都是一个Event，例如类加载（Class Load Event），CPU负载变动（CPULoad），垃圾回收（GarbageCollection）等。记录、丢失Event都属于一个Event。</p>
<h4 id="event">Event按照采集方式分为三种：</h4>
<ol>
<li>Instant Event：顾名思义，这种 Event 在发生时就立刻采集。例如：Throw Exception Event 还有 Thread Start Event，类似于这种在某一时刻发生的 Event</li>
<li>Duration Event：这种 Event 需要耗费一些时间，在完成的时候会记录。对于这种类型的 Event，可以设置一个时间限制，超过这个时间限制的才会记录。例如 GC Event，Thread Sleep Event。</li>
<li>Sample Event（或者是Requestable Event）：按照一定的频率采集，这个频率是可以配置的。例如 Thread Dump Event，Method Sampling Event</li>
</ol>
<p>Event会被写入到.jfr二进制文件中，可通过可视化工具JMC去查看。</p>
<h3 id="jfr_3">如何开启JFR</h3>
<p>官方文档：<a href="https://docs.oracle.com/javacomponents/jmc-5-4/jfr-runtime-guide/run.htm#JFRUH164">Running Java Flight Recorder</a></p>
<p>可以通过启动参数在 JVM 进程启动的时候就启动 JFR，或者是利用 jcmd 工具，动态启用或者关闭 JFR。</p>
<h4 id="jvm">JVM参数启动</h4>
<p>启动命令：</p>
<pre><code>java -XX:StartFlightRecording=disk=true,dumponexit=true,filename=recording.jfr,maxsize=1024m,maxage=1d,settings=profile,path-to-gc-roots=true test.Main

</code></pre>
<p>在 JDK 11 版本之后，启动参数被简化了很多很多；目前JFR涉及的参数仅仅只有两个，一个负责启动（<code>-XX:StartFlightRecording</code>），一个负责配置（<code>-XX:FlightRecorderOptions</code>）。JDK 8中的<code>-XX:+FlightRecorder</code>打开 FlightRecorder 状态。核心就是 <code>-XX:StartFlightRecording</code>，有了这个参数就会启用 JFR 记录。</p>
<h5 id="-xxstartflightrecording">-XX:StartFlightRecording参数说明</h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>delay</td>
<td>0</td>
<td>延迟多久后启动 JFR 记录，支持带单位配置， 例如 delay=60s（秒）， delay=20m（分钟）， delay=1h（小时）， delay=1d（天），不带单位就是秒， 0就是没有延迟直接开始记录。一般为了避免框架初始化等影响，我们会延迟 1 分钟开始记录（例如Spring cloud应用，可以看下日志中应用启动耗时，来决定下这个时间）。</td>
</tr>
<tr>
<td>disk</td>
<td>true</td>
<td>是否写入磁盘，这个就是上文提到的， global buffer 满了之后，是直接丢弃还是写入磁盘文件。</td>
</tr>
<tr>
<td>dumponexit</td>
<td>false</td>
<td>程序退出时，是否要dump出 .jfr文件</td>
</tr>
<tr>
<td>duration</td>
<td>0</td>
<td>JFR 记录持续时间，同样支持单位配置，不带单位就是秒，0代表不限制持续时间，一直记录。</td>
</tr>
<tr>
<td>filename</td>
<td>-</td>
<td>[启动目录]/hotspot-pid-26732-id-1-2020_03_12_10_07_22.jfr，pid 后面就是 pid， id 后面是第几个 JFR 记录，可以启动多个 JFR 记录。最后就是时间。dump的输出文件</td>
</tr>
<tr>
<td>name</td>
<td>无</td>
<td>记录名称，由于可以启动多个 JFR 记录，这个名称用于区分，否则只能看到一个记录 id，不好区分。</td>
</tr>
<tr>
<td>maxage</td>
<td>0</td>
<td>这个参数只有在 disk 为 true 的情况下才有效。最大文件记录保存时间，就是 global buffer 满了需要刷入本地临时目录下保存，这些文件最多保留多久的。也可以通过单位配置，没有单位就是秒，默认是0，就是不限制</td>
</tr>
<tr>
<td>maxsize</td>
<td>250MB</td>
<td>这个参数只有在 disk 为 true 的情况下才有效。最大文件大小，支持单位配置， 不带单位是字节，m或者M代表MB，g或者G代表GB。设置为0代表不限制大小<strong>。虽然官网说默认就是0，但是实际用的时候，不设置会有提示</strong>： No limit specified, using maxsize=250MB as default. 注意，这个配置不能小于后面将会提到的 maxchunksize 这个参数。</td>
</tr>
<tr>
<td>path-to-gc-roots</td>
<td>false</td>
<td>是否记录GC根节点到活动对象的路径，一般不打开这个，首先这个在我个人定位问题的时候，很难用到，只要你的编程习惯好。还有就是打开这个，性能损耗比较大，会导致FullGC一般是在怀疑有内存泄漏的时候热启动这种采集，并且通过产生对象堆栈无法定位的时候，动态打开即可。一般通过产生这个对象的堆栈就能定位，如果定位不到，怀疑有其他引用，例如 ThreadLocal 没有释放这样的，可以在 dump 的时候采集 gc roots</td>
</tr>
<tr>
<td>settings</td>
<td>default</td>
<td>采集 Event 的详细配置，采集的每个 Event 都有自己的详细配置。另一个 JDK 自带的配置是 profile.jfc，位于 <code>$JAVA_HOME/lib/jfr/profile.jfc</code>。</td>
</tr>
</tbody>
</table>
<h5 id="-xxflightrecorderoption">-XX:FlightRecorderOption参数说明</h5>
<table>
<thead>
<tr>
<th>参数名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>allow_threadbuffers_to_disk</td>
<td>false</td>
<td>是否允许 在 thread buffer 线程阻塞的时候，直接将 thread buffer 的内容写入文件。默认不启用，一般没必要开启这个参数，只要你设置的参数让 global buffer 大小合理不至于刷盘很慢，就行了。</td>
</tr>
<tr>
<td>globalbuffersize</td>
<td>如果不设置，根据设置的 memorysize 自动计算得出</td>
<td>单个 global buffer 的大小，一般通过 memorysize 设置，不建议自己设置</td>
</tr>
<tr>
<td>maxchunksize</td>
<td>12M</td>
<td>存入磁盘的每个临时文件的大小。默认为12MB，不能小于1M。可以用单位配置，不带单位是字节，m或者M代表MB，g或者G代表GB。注意这个大小最好不要比 memorySize 小，更不能比 globalbuffersize 小，否则会导致性能下降</td>
</tr>
<tr>
<td>memorysize</td>
<td>10M</td>
<td>JFR的 global buffer 占用的整体内存大小，一般通过设置这个参数，numglobalbuffers 还有 globalbuffersize 会被自动计算出。可以用单位配置，不带单位是字节，m或者M代表MB，g或者G代表GB。</td>
</tr>
<tr>
<td>numglobalbuffers</td>
<td>如果不设置，根据设置的 memorysize 自动计算得出</td>
<td>global buffer的个数，一般通过 memorysize 设置，不建议自己设置</td>
</tr>
<tr>
<td>old-object-queue-size</td>
<td>256</td>
<td>对于Profiling中的 Old Object Sample 事件，记录多少个 Old Object，这个配置并不是越大越好。记录是怎么记录的，会在后面的各种 Event 介绍里面详细介绍。我的建议是，一般应用256就够，时间跨度大的，例如 maxage 保存了一周以上的，可以翻倍</td>
</tr>
<tr>
<td>repository</td>
<td>等同于 -Djava.io.tmpdir 指定的目录</td>
<td>JFR 保存到磁盘的临时记录的位置</td>
</tr>
<tr>
<td>retransform</td>
<td>true</td>
<td>是否通过 JVMTI 转换 JFR 相关 Event 类，如果设置为 false，则只在 Event 类加载的时候添加相应的 Java Instrumentation，这个一般不用改，这点内存 metaspace 还是足够的</td>
</tr>
<tr>
<td>samplethreads</td>
<td>true</td>
<td>这个是是否开启线程采集的状态位配置，只有这个配置为 true，并且在 Event 配置中开启线程相关的采集（这个后面会提到），才会采集这些事件。</td>
</tr>
<tr>
<td>stackdepth</td>
<td>64</td>
<td>采集事件堆栈深度，有些 Event 会采集堆栈，这个堆栈采集的深度，统一由这个配置指定。注意这个值不能设置过大，如果你采集的 Event种类很多，堆栈深度大很影响性能。比如你用的是 default.jfc 配置的采集，堆栈深度64基本上就是不影响性能的极限了。你可以自定义采集某些事件，增加堆栈深度。</td>
</tr>
<tr>
<td>threadbuffersize</td>
<td>8KB</td>
<td>threadBuffer 大小，最好不要修改这个，如果增大，那么随着你的线程数增多，内存占用会增大。过小的话，刷入 global buffer 的次数就会变多。8KB 就是经验中最合适的。</td>
</tr>
</tbody>
</table>
<h4 id="jcmd">JCMD启动</h4>
<p>至于JCMD是什么，可以看下<a href="#JCMD">JCMD</a></p>
<p>1、<strong>jcmd <pid> JFR.start</strong>：启动 JFR 记录，参数和<code>-XX:StartFlightRecording</code>一模一样，<strong>请参考上面的表格</strong>。但是注意这里不再是逗号分割，而是空格 示例：</p>
<pre><code>jcmd 21 JFR.start name=profile_online maxage=1d maxsize=1g
</code></pre>
<p>这个就代表启动一个名称为 profile_online, 最多保留一天，最大保留 1G 的本地文件记录</p>
<p>2、<strong>jcmd <pid> JFR.stop</strong>. 停止 JFR 记录，需要传入名称，例如如果要停止上面打开的，则执行：</p>
<pre><code class="language-text">jcmd 21 JFR.stop name=profile_online copy_to_file=profile.jfr
</code></pre>
<p><strong>copy_to_file</strong>:停止时同时复制到文件，指定文件输出位置</p>
<p>3、jcmd <pid> JFR.check，查看当前正在执行的 JFR 记录。</p>
<p>示例：</p>
<pre><code class="language-text">jcmd 21 JFR.check verbose=true
</code></pre>
<p>输出：</p>
<pre><code class="language-text">21:
Recording 1: name=profile_online maxsize=1.0GB maxage=1d (running)
</code></pre>
<p>verbose：是否查看每种Event采集详细配置</p>
<p>4、<strong>jcmd <pid> JFR.configure</strong>，如果不传入参数，则是查看当前配置，传入参数就是修改配置。配置与-XX:FlightRecorderOptions的一模一样。<strong>请参考上面的表格</strong> 示例：</p>
<pre><code class="language-text">./jcmd 21 JFR.configure
</code></pre>
<p>输出：</p>
<pre><code class="language-text">Repository path: /tmp/2020_03_18_08_41_44_21

Stack depth: 64
Global buffer count: 20
Global buffer size: 512.0 kB
Thread buffer size: 8.0 kB
Memory size: 10.0 MB
Max chunk size: 12.0 MB
Sample threads: true
</code></pre>
<p>示例：</p>
<pre><code class="language-text">./jcmd 21 JFR.configure stackdepth=65
</code></pre>
<p>输出：</p>
<pre><code class="language-text">21:
Stack depth: 65
</code></pre>
<p>5、<strong><code>jcmd &lt;pid&gt; JFR.dump</code></strong> :dump性能日志</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>无</td>
<td>指定要查看的 JFR 记录名称</td>
</tr>
<tr>
<td>filename</td>
<td>无</td>
<td>指定文件输出位置</td>
</tr>
<tr>
<td>maxage</td>
<td>0</td>
<td>dump最多的时间范围的文件，可以通过单位配置，没有单位就是秒，默认是0，就是不限制</td>
</tr>
<tr>
<td>maxsize</td>
<td>0</td>
<td>dump最大文件大小，支持单位配置， 不带单位是字节，m或者M代表MB，g或者G代表GB。设置为0代表不限制大小</td>
</tr>
<tr>
<td>begin</td>
<td>无</td>
<td>dump开始位置， 可以这么配置：09:00, 21:35:00, 2018-06-03T18:12:56.827Z, 2018-06-03T20:13:46.832, -10m, -3h, or -1d</td>
</tr>
<tr>
<td>end :</td>
<td>无</td>
<td>dump结束位置，可以这么配置： 09:00, 21:35:00, 2018-06-03T18:12:56.827Z, 2018-06-03T20:13:46.832, -10m, -3h, or -1d (STRING, no default value)</td>
</tr>
<tr>
<td>path-to-gc-roots</td>
<td>false</td>
<td>是否记录GC根节点到活动对象的路径，一般不记录，dump 的时候打开这个肯定会触发一次 fullGC，对线上应用有影响。最好参考之前对于 JFR 启动记录参数的这个参数的描述，考虑是否有必要</td>
</tr>
</tbody>
</table>
<h1 id="jmc">JMC</h1>
<h3 id="jmc_1">什么是JMC</h3>
<p>JMC（JAVA MISSION CONTROL）是和JFR结合使用的，由于JFR生成的报告是二进制文件，所以需要有一个可视化界面去分析，那么JMC就是这个可视化工具。可以查看应用（线程、内存、IO、异常等）、JVM（GC、GC配置、类加载等）、环境（环境变量、系统变量等）的详细信息。</p>
<p><strong>可以通过连接JVM或者读取jfr文件读取相应信息</strong></p>
<p>具体使用不再做详细赘述，感兴趣的可以看下这篇博客:<a href="https://blog.csdn.net/yue530tomtom/article/details/80805412">JMC使用说明</a></p>
<p><img alt="JMC" src="https://tva1.sinaimg.cn/large/e6c9d24egy1gzxwskxqo2j21ga0u0jvl.jpg" /></p>
<h2 id="jcmd_1">JCMD</h2>
<blockquote>
<p>发送诊断命令请求到正在运行的Java虚拟机（JVM）。它必须和JVM运行在同一台机器上，并且与启动JVM用户具有相同的组权限。</p>
</blockquote>
<p>可通过jcmd <PID> help 查看命令，下面列了一些常用</p>
<h3 id="_2">常用命令</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>jcmd PID VM.uptime</td>
<td>查看 JVM 的启动时长</td>
</tr>
<tr>
<td>jcmd PID GC.class_histogram</td>
<td>查看 JVM 的类信息，这个可以查看每个类的实例数量和占用空间大小。</td>
</tr>
<tr>
<td>jcmd PID Thread.print</td>
<td>查看 JVM 的Thread Dump</td>
</tr>
<tr>
<td>jcmd PID GC.heap_dump FILE_NAME</td>
<td>查看 JVM 的Heap Dump,注意，如果只指定文件名，默认会生成在启动 JVM 的目录里。</td>
</tr>
<tr>
<td>jcmd PID VM.system_properties</td>
<td>查看 JVM 的属性信息</td>
</tr>
<tr>
<td>jcmd PID VM.flags</td>
<td>查看 JVM 的启动参数,注意，可以看到 -X 和 -XX 的参数信息</td>
</tr>
<tr>
<td>jcmd PID VM.command_line</td>
<td>查看 JVM 的启动命令行</td>
</tr>
<tr>
<td>jcmd PID GC.run_finalization</td>
<td>对 JVM 执行 java.lang.System.runFinalization(),尽量b别去调用这个对象的finalize方法。</td>
</tr>
<tr>
<td>jcmd PID GC.run</td>
<td>对 JVM 执行 java.lang.System.gc()，告诉垃圾收集器打算进行垃圾收集，而垃圾收集器进不进行收集是不确定的</td>
</tr>
<tr>
<td>jcmd PID PerfCounter.print</td>
<td>查看 JVM 的性能</td>
</tr>
</tbody>
</table>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../../Elasticsearch/queries/%E8%A1%B0%E5%87%8F%E5%87%BD%E6%95%B0/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 衰减函数" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              衰减函数
            </div>
          </div>
        </a>
      
      
        
        <a href="../../Lucene/Lucene%20Segment%20Merge%E5%8E%9F%E7%90%86%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="md-footer__link md-footer__link--next" aria-label="Next: Lucene Segment Merge原理及源码分析" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Lucene Segment Merge原理及源码分析
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.bd0b6b67.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.467223ff.min.js"></script>
      
    
  </body>
</html>